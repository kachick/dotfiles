# This is a patch for official Lima templates.
# Use it like:
#   yq eval-all 'select(fileIndex == 0) * select(fileIndex == 1) | .provision = select(fileIndex == 0).provision + select(fileIndex == 1).provision | .mounts = select(fileIndex == 0).mounts + select(fileIndex == 1).mounts' dist/docker.yaml config/lima/patch.yaml

user:
  name: 'user'

mounts:
  - location: '~'
    writable: false
  - location: '~/repos'
    mountPoint: '{{.Home}}/repos'
    writable: true

provision:
  # 1. Install Nix (Multi-user) and enable flakes
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      if ! command -v nix >/dev/null 2>&1; then
        curl -L https://nixos.org/nix/install | sh -s -- --daemon --yes
      fi

      # Force Nix profile loading for non-interactive shells in Ubuntu
      # https://github.com/NixOS/nix/issues/2407#issuecomment-411513180
      if ! grep -q "nix-daemon.sh" /etc/bash.bashrc; then
        echo 'if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh; fi' >> /etc/bash.bashrc
      fi

      # Enable flakes
      mkdir -p /etc/nix
      if ! grep -q "experimental-features" /etc/nix/nix.conf 2>/dev/null; then
        echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf
        if command -v systemctl >/dev/null 2>&1; then
          systemctl restart nix-daemon
        fi
      fi
  # 2. Apply home-manager
  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Source Nix for the current provisioning session
      if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
      fi

      DOTFILES_DIR="$HOME/repos/github.com/kachick/dotfiles"
      cd "$DOTFILES_DIR"
      nix run '.#home-manager' -- switch -b backup --show-trace --flake ".#user@lima"
