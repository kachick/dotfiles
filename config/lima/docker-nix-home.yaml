# This template inherits from docker-nix.yaml and adds home-manager provisioning.
# See: https://lima-vm.io/docs/templates/

base:
  - ./docker-nix.yaml

# Configuration parameters that can be overridden via `limactl create --set`
param:
  # The flake URI to use for provisioning.
  # Can be a GitHub URL or a local path.
  flake: 'github:kachick/dotfiles/main'

provision:
  # 2. Apply home-manager
  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Step 3 in README Ubuntu section
      mkdir -p ~/.local/state/nix/profiles

      # Source Nix for the current provisioning session
      if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
      fi

      # Apply home-manager configuration using the provided Flake URI.
      # This follows the README instructions while allowing branch/path overrides.
      nix run "{{.Param.flake}}#home-manager" -- switch -b backup --show-trace --flake "{{.Param.flake}}#user@lima"
