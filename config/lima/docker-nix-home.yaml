# This template inherits from docker-nix.yaml and adds home-manager provisioning.
# See: https://lima-vm.io/docs/templates/

base:
  - ./docker-nix.yaml

provision:
  # 2. Apply home-manager
  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Step 3 in README Ubuntu section
      mkdir -p ~/.local/state/nix/profiles

      # Source Nix for the current provisioning session
      if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
      fi

      # Use the standard path as used in kachick's environment.
      # In GHA, we ensure this path exists via explicit --mount.
      # In local, it is usually provided by global mounts in _config/default.yaml.
      DOTFILES_DIR="{{.Home}}/repos/github.com/kachick/dotfiles"
      if [ ! -d "$DOTFILES_DIR" ]; then
        echo "Dotfiles directory not found at $DOTFILES_DIR. Ensure it is mounted."
        exit 1
      fi

      cd "$DOTFILES_DIR"
      # Apply home-manager configuration for "user@lima"
      nix run '.#home-manager' -- switch -b backup --show-trace --flake ".#user@lima"
